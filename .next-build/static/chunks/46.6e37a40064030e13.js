"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[46],{4046:function(e,t,l){l.r(t),l.d(t,{default:function(){return N}});var a=l(7437),s=l(2265),n=l(5394),i=l(9294),r=l(4628),o=l(3697),c=l(430),d=l(1791),u=l(7847);let m="flow_admin_draft_v1",x="https://www.simonanicolaescu.ro/wp-content/uploads/2021/10/1-2-trecerea-peste-obstacole.mp3",p="/audio/1-2-trecerea-peste-obstacole.mp3";function f(){try{let e=localStorage.getItem(m);if(!e)return null;let t=JSON.parse(e);if(!t||1!==t.version||!Array.isArray(t.flows))return null;let l=new Set(t.flows.map(e=>"string"==typeof(null==e?void 0:e.id)?e.id:null).filter(Boolean)),a=new Set(c.Y.map(e=>e.id)),s=0;for(let e of Array.from(l))a.has(e)&&(s+=1);let n=Math.max(l.size,a.size),i=0===n?1:s/n;if(0===s||i<.5){try{localStorage.removeItem(m)}catch(e){}return null}return t.flows.map(e=>({...e,practices:Array.isArray(e.practices)?e.practices.map(e=>{var t,l;return{...e,audioUrl:(null==e?void 0:null===(t=e.audioUrl)||void 0===t?void 0:t.ro)===x||(null==e?void 0:null===(l=e.audioUrl)||void 0===l?void 0:l.en)===x?{ro:p,en:p}:e.audioUrl}}):e.practices}))}catch(e){return null}}let h="assets";async function g(e){let t=await new Promise((e,t)=>{let l=indexedDB.open("flow_admin_assets",1);l.onupgradeneeded=()=>{let e=l.result;e.objectStoreNames.contains(h)||e.createObjectStore(h,{keyPath:"key"})},l.onsuccess=()=>e(l.result),l.onerror=()=>t(l.error)}),l=await new Promise((l,a)=>{let s=t.transaction(h,"readonly").objectStore(h).get(e);s.onsuccess=()=>{var e;return l(null!==(e=s.result)&&void 0!==e?e:null)},s.onerror=()=>a(s.error)});return t.close(),l}async function v(e){return await new Promise((t,l)=>{let a=new FileReader;a.onerror=()=>l(Error("Failed to read file")),a.onload=()=>t(String(a.result||"")),a.readAsDataURL(e)})}function w(){let e=o.Z.useState(e=>e.flows),t=(0,s.useMemo)(()=>{var t;return null!==(t=f())&&void 0!==t?t:e},[e]),[l,r]=(0,s.useState)(!1),[c,d]=(0,s.useState)(""),u="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname,m=async()=>{if(u){r(!0),d("");try{let e={},l=new Set;for(let a of(t.forEach(e=>{var t,a;[null===(t=e.image)||void 0===t?void 0:t.ro,null===(a=e.image)||void 0===a?void 0:a.en].forEach(e=>{"string"==typeof e&&e.startsWith("asset:")&&l.add(e.slice(6))})}),Array.from(l))){let t=await g(a);t&&(e[a]={dataUrl:await v(t.blob),mime:t.mime,name:t.name})}let a=await fetch("/api/admin/write-content",{method:"POST",headers:{"content-type":"application/json","x-admin-token":"flowbalance_local_admin_write_2026-01-03_6d9f3c7a8b2e4f1c9a0d3e7b5c1f8a6d"},body:JSON.stringify({flows:t,assets:e})});if(!a.ok){let e=await a.text();throw Error(e||"Request failed: ".concat(a.status))}d("Saved to repo files successfully.")}catch(e){d("Save failed: ".concat((null==e?void 0:e.message)||String(e)))}finally{r(!1)}}};return u?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(n.YG,{onClick:m,disabled:l,color:"light",size:"small",children:[(0,a.jsx)(n.gu,{icon:i.Z8j,slot:"start"}),l?"Savingâ€¦":"Save to repo"]}),c?(0,a.jsx)("span",{className:"text-xs text-white/80",children:c}):null]}):null}function b(e){return e.map((e,t)=>({...e,position:t+1}))}function j(e){let{isOpen:t,practice:l,onClose:n,onSave:i}=e,[r,o]=(0,s.useState)(l);return((0,s.useEffect)(()=>{o(l)},[l]),t&&r)?(0,a.jsx)("div",{className:"fixed inset-0 z-[9999] bg-black/60 flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-2xl rounded-2xl bg-white p-5",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900",children:"Edit practice"}),(0,a.jsx)("button",{className:"text-gray-500 hover:text-gray-700",onClick:n,type:"button",children:"Close"})]}),(0,a.jsxs)("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Practice ID"}),(0,a.jsx)("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.id,onChange:e=>o({...r,id:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Audio URL (RO)"}),(0,a.jsx)("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.audioUrl.ro,onChange:e=>o({...r,audioUrl:{...r.audioUrl,ro:e.target.value}})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Title (RO)"}),(0,a.jsx)("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.title.ro,onChange:e=>o({...r,title:{...r.title,ro:e.target.value}})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Title (EN)"}),(0,a.jsx)("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.title.en,onChange:e=>o({...r,title:{...r.title,en:e.target.value}})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Name (RO)"}),(0,a.jsx)("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.name.ro,onChange:e=>o({...r,name:{...r.name,ro:e.target.value}})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Name (EN)"}),(0,a.jsx)("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.name.en,onChange:e=>o({...r,name:{...r.name,en:e.target.value}})})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Description (RO)"}),(0,a.jsx)("textarea",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.description.ro,onChange:e=>o({...r,description:{...r.description,ro:e.target.value}}),rows:4})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Description (EN)"}),(0,a.jsx)("textarea",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.description.en,onChange:e=>o({...r,description:{...r.description,en:e.target.value}}),rows:4})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"text-sm font-semibold text-gray-700",children:"Audio URL (EN)"}),(0,a.jsx)("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",value:r.audioUrl.en,onChange:e=>o({...r,audioUrl:{...r.audioUrl,en:e.target.value}})})]})]}),(0,a.jsxs)("div",{className:"mt-5 flex justify-end gap-2",children:[(0,a.jsx)("button",{className:"rounded-lg border px-4 py-2 text-sm",onClick:n,type:"button",children:"Cancel"}),(0,a.jsx)("button",{className:"rounded-lg bg-purple-600 px-4 py-2 text-sm font-semibold text-white hover:bg-purple-700",onClick:()=>i(r),type:"button",children:"Save"})]})]})}):null}function y(e){let{practice:t,idx:l,flowId:s,flowIndex:r,lang:o,onMove:u,onEdit:m}=e,x=(0,d.T)(s,t.id,r,l);return(0,a.jsxs)(n.Ie,{className:"no-bg-color py-4 text-white",routerLink:"/flows/".concat(s,"/").concat(t.id),children:[(0,a.jsx)(n.gu,{className:"text-white text-3xl",icon:x?i.S38:i.hkI}),(0,a.jsxs)(n.Q$,{className:"pl-5 text-white text-lg",children:[(0,c.t)(t.name,o),!x&&(0,a.jsx)(n.yp,{color:"warning",className:"ml-2",children:"Premium"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)("button",{type:"button",className:"rounded-lg bg-white/10 hover:bg-white/20 px-2 py-1 text-white text-sm",onClick:e=>{e.preventDefault(),e.stopPropagation(),u(l,-1)},title:"Move up",children:(0,a.jsx)(n.gu,{icon:i.Edm})}),(0,a.jsx)("button",{type:"button",className:"rounded-lg bg-white/10 hover:bg-white/20 px-2 py-1 text-white text-sm",onClick:e=>{e.preventDefault(),e.stopPropagation(),u(l,1)},title:"Move down",children:(0,a.jsx)(n.gu,{icon:i.o9Y})}),(0,a.jsx)("button",{type:"button",className:"rounded-lg bg-white/10 hover:bg-white/20 px-2 py-1 text-white text-sm",onClick:e=>{e.preventDefault(),e.stopPropagation(),m(t.id)},title:"Edit",children:(0,a.jsx)(n.gu,{icon:i.mjL})})]})]},t.id)}function N(e){var t,l;let{flowId:c,flowIndex:d,lang:x}=e;(0,r.k6)();let p=o.Z.useState(e=>e.isSuperAdmin)&&(0,u.h)(),h=o.Z.useState(e=>e.flows),g=null!==(t=h.find(e=>e.id===c))&&void 0!==t?t:null;(0,s.useEffect)(()=>{if(!p)return;let e=f();e&&o.Z.update(t=>{t.flows=e})},[p]);let v=(0,s.useMemo)(()=>{var e;return b(null!==(e=null==g?void 0:g.practices)&&void 0!==e?e:[])},[null==g?void 0:g.practices]),N=e=>{o.Z.update(t=>{t.flows=e}),function(e){try{localStorage.setItem(m,JSON.stringify({version:1,flows:e}))}catch(e){}}(e)},S=e=>{g&&N(h.map(t=>t.id===g.id?{...t,practices:b(e),totalPractices:e.length}:t))},C=(e,t)=>{let l=[...v],a=e+t;if(a<0||a>=l.length)return;let s=l[e];l[e]=l[a],l[a]=s,S(l)},[k,P]=(0,s.useState)(null),E=null!==(l=v.find(e=>e.id===k))&&void 0!==l?l:null;return p&&g?(0,a.jsxs)("div",{className:"no-bg-color",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between px-2 py-2",children:[(0,a.jsx)("div",{className:"text-xs text-white/70",children:"Admin draft mode (local only)."}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(w,{}),(0,a.jsxs)(n.YG,{onClick:()=>{var e;S([...v,(e=v.length+1,{id:"NewPractice-".concat(Date.now()),position:e,title:{ro:"New Practice",en:"New Practice"},name:{ro:"New Practice",en:"New Practice"},intro:{ro:"",en:""},description:{ro:"",en:""},audioUrl:{ro:"",en:""},finished:!1,lastPositionSec:0})])},color:"light",size:"small",children:[(0,a.jsx)(n.gu,{icon:i.s6O,slot:"start"}),"New practice"]})]})]}),v.map((e,t)=>(0,a.jsx)(y,{practice:e,idx:t,flowId:c,flowIndex:d,lang:x,onMove:C,onEdit:P},e.id)),(0,a.jsx)(j,{isOpen:!!k,practice:E,onClose:()=>P(null),onSave:e=>{S(v.map(t=>t.id===k?{...e,finished:t.finished,lastPositionSec:t.lastPositionSec}:t)),P(null)}})]}):null}}}]);