/**
 * One-time generator for `flows-updates`.
 *
 * - For each of the 35 new flows, generates `Day-1..Day-12/practice.ts`.
 * - Updates each flow's `flow.ts` to include the practices + autogenerated intro/description.
 * - All practices point to the same audio URL (Stress Break Day 1).
 *
 * Run:
 *   node scripts/generate-12-practices.js
 */
/* eslint-disable no-console */

const fs = require('fs/promises');
const path = require('path');

const repoRoot = path.join(__dirname, '..');
const flowsRoot = path.join(repoRoot, 'data', 'flows');

// Use a same-origin file during dev to avoid CORS issues for the visualizer.
// (We can switch back to remote or a proxy before release.)
// Store the R2 object key (not a local /public/audio path).
const AUDIO_URL = '1-2-trecerea-peste-obstacole.mp3';

function titleCase(input) {
  return input
    .trim()
    .split(/\s+/g)
    .map(w => (w.length ? w[0].toUpperCase() + w.slice(1) : w))
    .join(' ');
}

function slugify(input) {
  return input
    .trim()
    .replace(/['"]/g, '')
    .replace(/[^a-zA-Z0-9]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
}

const categories = [
  {
    name: 'Emotional Regulation',
    goal: {
      en: 'regulate emotions and return to calm',
      ro: 'îți reglezi emoțiile și revii la calm',
    },
    flows: [
      { en: 'Calming Anxiety', ro: 'Calmarea anxietății' },
      { en: 'Panic Support', ro: 'Sprijin în panică' },
      { en: 'Craving Relief', ro: 'Reducerea poftelor' },
      { en: 'Ease Overwhelm', ro: 'Reducerea copleșirii' },
      { en: 'Stress Soothing', ro: 'Liniștirea stresului' },
      { en: 'Calm Your Nervous System', ro: 'Calmează-ți sistemul nervos' },
      { en: 'Improve Sleep', ro: 'Îmbunătățește somnul' },
    ],
  },
  {
    name: 'Performance Boost',
    goal: {
      en: 'build clarity, focus, and calm under pressure',
      ro: 'construiești claritate, concentrare și calm sub presiune',
    },
    flows: [
      { en: 'Boost Performance', ro: 'Crește performanța' },
      { en: 'Improve Focus', ro: 'Îmbunătățește concentrarea' },
      { en: 'Productivity Support', ro: 'Sprijin pentru productivitate' },
      { en: 'Mental Clarity', ro: 'Claritate mentală' },
      { en: 'Calm Under Pressure', ro: 'Calm sub presiune' },
      { en: 'Decision Confidence', ro: 'Încredere în decizii' },
      { en: 'Energy Balance', ro: 'Echilibru energetic' },
    ],
  },
  {
    name: 'Mindset',
    goal: {
      en: 'strengthen a steady, confident mindset',
      ro: 'îți întărești un mindset stabil și încrezător',
    },
    flows: [
      { en: 'Positive Mindset', ro: 'Mindset pozitiv' },
      { en: 'Mindset during Competitions', ro: 'Mindset în competiții' },
      { en: 'Public Speaking Confidence', ro: 'Încredere în vorbitul în public' },
      { en: 'Goal Achievement', ro: 'Atingerea obiectivelor' },
      { en: 'Build Self-Trust', ro: 'Construiește încrederea în tine' },
      { en: 'Boost Confidence', ro: 'Crește încrederea' },
      { en: 'Healthy Money Mindset', ro: 'Mindset sănătos despre bani' },
    ],
  },
  {
    name: 'Stories',
    goal: {
      en: 'slow down with calming stories and reflection',
      ro: 'încetinești ritmul cu povești pentru calm și reflecție',
    },
    flows: [
      { en: 'Calm Stories', ro: 'Povești pentru calm' },
      { en: 'Reflection Stories', ro: 'Povești de reflecție' },
      { en: 'Growth Stories', ro: 'Povești de creștere' },
      { en: 'Insight Stories', ro: 'Povești de claritate' },
    ],
  },
  {
    name: 'Heart Balance',
    goal: {
      en: 'open the heart with gratitude and compassion',
      ro: 'îți deschizi inima prin recunoștință și compasiune',
    },
    flows: [
      { en: 'Heartful Gratitude', ro: 'Recunoștință din inimă' },
      { en: 'Boost Motivation', ro: 'Crește motivația' },
      { en: 'Heart-Centered Balance', ro: 'Echilibru centrat pe inimă' },
      { en: 'Self Compassion', ro: 'Compasiune de sine' },
      { en: 'Daily Heart Lift', ro: 'Revigorare zilnică a inimii' },
      { en: 'Heartful Affirmations', ro: 'Afirmații din inimă' },
    ],
  },
  {
    name: 'Somatic Release',
    goal: {
      en: 'release tension through the body and breath',
      ro: 'eliberezi tensiunea prin corp și respirație',
    },
    flows: [
      { en: 'Body Release', ro: 'Eliberare corporală' },
      { en: 'Grounding', ro: 'Împământare' },
      { en: 'Shake Method', ro: 'Metoda scuturării' },
      { en: 'Nervous System Reset', ro: 'Resetarea sistemului nervos' },
    ],
  },
];

const LOREM =
  'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.';
const LOREM2 =
  'Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.';

function pad2(n) {
  return String(n).padStart(2, '0');
}

function renderPracticeTs({ flowId, day, flowNameEn, flowNameRo }) {
  const dayLabelEn = `Day ${day}`;
  const dayLabelRo = `Ziua ${day}`;
  const practiceId = `${flowId}-Day-${pad2(day)}`;

  return `import type { Practice } from '../../types';

const practice: Practice = {
  id: ${JSON.stringify(practiceId)},
  position: ${day},
  title: { ro: ${JSON.stringify(`${flowNameRo} - ${dayLabelRo}`)}, en: ${JSON.stringify(
    `${flowNameEn} - ${dayLabelEn}`,
  )} },
  name: { ro: ${JSON.stringify(dayLabelRo)}, en: ${JSON.stringify(dayLabelEn)} },
  intro: { ro: ${JSON.stringify(LOREM)}, en: ${JSON.stringify(LOREM)} },
  description: { ro: ${JSON.stringify(`${LOREM} ${LOREM2}`)}, en: ${JSON.stringify(
    `${LOREM} ${LOREM2}`,
  )} },
  audioUrl: { ro: ${JSON.stringify(AUDIO_URL)}, en: ${JSON.stringify(AUDIO_URL)} },

  finished: false,
  lastPositionSec: 0,
};

export default practice;
`;
}

function renderFlowTs({
  flowId,
  position,
  flowNameEn,
  flowNameRo,
  goalEn,
  goalRo,
  practicesCount,
  imagePath,
}) {
  const imports = [];
  const practiceVars = [];
  for (let day = 1; day <= practicesCount; day += 1) {
    const varName = `practice_${day}`;
    imports.push(`import ${varName} from "./Day-${day}/practice";`);
    practiceVars.push(varName);
  }

  const introEn = `A 12-day series to help you ${goalEn}.`;
  const introRo = `Un program de 12 zile care te ajută să ${goalRo}.`;
  const descEn = `In ${flowNameEn}, you’ll do short, repeatable practices designed to ${goalEn}. Each day, you come back to breath, body, and attention—so you can respond with more clarity and less reactivity. No pressure: just press play and let it land.`;
  const descRo = `În ${flowNameRo}, vei face practici scurte și repetabile, create să te ajute să ${goalRo}. În fiecare zi, revii la respirație, corp și atenție—ca să răspunzi cu mai multă claritate și mai puțină reactivitate. Fără presiune: doar apasă play și lasă practica să se așeze.`;

  return `import type { Flow } from '../types';
${imports.join('\n')}

const flow: Flow = {
  id: ${JSON.stringify(flowId)},
  position: ${position},

  title: { ro: ${JSON.stringify(flowNameRo)}, en: ${JSON.stringify(flowNameEn)} },
  name: { ro: ${JSON.stringify(flowNameRo)}, en: ${JSON.stringify(flowNameEn)} },
  intro: { ro: ${JSON.stringify(introRo)}, en: ${JSON.stringify(introEn)} },
  description: { ro: ${JSON.stringify(descRo)}, en: ${JSON.stringify(descEn)} },
  image: { ro: ${JSON.stringify(imagePath)}, en: ${JSON.stringify(imagePath)} },

  started: false,
  finished: false,
  practicesCompleted: 0,
  lastPracticeFinishedId: null,
  lastPracticePositionSec: 0,

  totalPractices: ${practicesCount},
  practices: [${practiceVars.join(', ')}],
};

export default flow;
`;
}

async function main() {
  const flattened = [];
  for (const cat of categories) {
    for (const flow of cat.flows) {
      flattened.push({ ...flow, goal: cat.goal });
    }
  }

  let position = 1;
  for (const flow of flattened) {
    const flowNameEn = titleCase(flow.en);
    const flowNameRo = flow.ro;
    const folderName = slugify(flowNameEn);
    const flowId = folderName;

    const flowDir = path.join(flowsRoot, folderName);
    await fs.mkdir(flowDir, { recursive: true });

    // practices
    const practicesCount = 12;
    for (let day = 1; day <= practicesCount; day += 1) {
      const dayDir = path.join(flowDir, `Day-${day}`);
      await fs.mkdir(dayDir, { recursive: true });
      await fs.writeFile(
        path.join(dayDir, 'practice.ts'),
        renderPracticeTs({ flowId, day, flowNameEn, flowNameRo }),
        'utf8',
      );
    }

    // flow.ts (overwrite placeholder)
    await fs.writeFile(
      path.join(flowDir, 'flow.ts'),
      renderFlowTs({
        flowId,
        position,
        flowNameEn,
        flowNameRo,
        goalEn: flow.goal.en,
        goalRo: flow.goal.ro,
        practicesCount,
        imagePath: '/img/flow-bg.jpg',
      }),
      'utf8',
    );

    position += 1;
  }

  console.log(`Generated ${flattened.length} flows × 12 practices each.`);
}

main().catch(err => {
  console.error(err);
  process.exit(1);
});

